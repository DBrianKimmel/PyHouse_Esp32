/*
 * mqtt_transport.c
 *
 *  Created on: Feb 18, 2017
 *      Author: briank
 */

#include <stdio.h>
#include <string.h>

#include "freertos/FreeRTOS.h"
#include "esp_log.h"
#include "esp_system.h"
#include "lwip/sockets.h"
#include "lwip/dns.h"
#include "lwip/netdb.h"

#include "mqtt_structs.h"
#include "mqtt_transport.h"


static const char *TAG = "Mqtt_Transport";


/*
 *  Set the socket timeout (in seconds)
 */
void mqtt_transport_set_timeout(uint32_t p_socket, int p_timeout) {
	struct timeval l_timeout;

	l_timeout.tv_sec = p_timeout; /* 10 Secs Timeout */
	l_timeout.tv_usec = 0;  // Not init'ing this can cause strange error                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 s
	setsockopt(p_socket, SOL_SOCKET, SO_RCVTIMEO, (char * )&l_timeout, sizeof(struct timeval));
}

/*
 * In order to avoid coppying stuff all over, we can write the 3 parts of the packet
 */
int mqtt_transport_write(uint32_t p_socket, PacketInfo_t *p_packet) {
	int l_write_length = 0;
	ESP_LOGI(TAG, "TransportWrite - Begin");
	l_write_length += write(p_socket, p_packet->PacketFixedHeader, p_packet->PacketFixedHeader_length);
	ESP_LOGI(TAG, "TransportWrite - Fixed:%d", l_write_length);
	l_write_length += write(p_socket, p_packet->PacketVariableHeader, p_packet->PacketVariableHeader_length);
	ESP_LOGI(TAG, "TransportWrite - Variable:%d", l_write_length);
	l_write_length += write(p_socket, p_packet->PacketPayload, p_packet->PacketPayload_length);
	ESP_LOGI(TAG, "TransportWrite - Payload:%d", l_write_length);
	return l_write_length;
}

int mqtt_transport_read(uint32_t p_socket, uint8_t *p_buffer){
	int l_read_length = 0;
	ESP_LOGI(TAG, "TransportRead - Begin");
	l_read_length = read(p_socket, p_buffer, CONFIG_MQTT_BUFFER_SIZE_BYTE);
	ESP_LOGI(TAG, "TransportRead - Length:%d", l_read_length);
	return l_read_length;
}


/**
 *
 */
static int resolve_dns(const char *p_host, struct sockaddr_in *p_ip) {
	struct hostent *l_he;
	struct in_addr **l_addr_list;
	ESP_LOGI(TAG, "Resolve_Dns - All");
	l_he = gethostbyname(p_host);
	if (l_he == NULL)
		return 0;
	l_addr_list = (struct in_addr **) l_he->h_addr_list;
	if (l_addr_list[0] == NULL)
		return 0;
	p_ip->sin_family = AF_INET;
	memcpy(&p_ip->sin_addr, l_addr_list[0], sizeof(p_ip->sin_addr));
	return 1;
}

/**
 * Establish a network connection to the broker.
 */
int mqtt_transport_connect(const char *p_host, int p_port) {
	int   l_sock;
	struct sockaddr_in   l_remote_ip;
	ESP_LOGI(TAG, " 45 Client_Connect - Begin     ");
	while (1) {
		bzero(&l_remote_ip, sizeof(struct sockaddr_in));
		l_remote_ip.sin_family = AF_INET;
		//if stream_host is not ip address, resolve it
		if (inet_aton(p_host, &(l_remote_ip.sin_addr)) == 0) {
			ESP_LOGI(TAG, " 51 Client_Connect - Resolve dns for domain: %s", p_host);
			if (!resolve_dns(p_host, &l_remote_ip)) {
				vTaskDelay(1000 / portTICK_RATE_MS);
				continue;
			}
		}
		l_sock = socket(PF_INET, SOCK_STREAM, IPPROTO_TCP);
		if (l_sock == -1) {
			continue;
		}
		l_remote_ip.sin_port = htons(p_port);
		ESP_LOGI(TAG, " 62 Client_Connect - Connecting to server %s: port:%d, From Local port:%d", inet_ntoa((l_remote_ip.sin_addr)), p_port, l_remote_ip.sin_port);
		if (connect(l_sock, (struct sockaddr * )(&l_remote_ip), sizeof(struct sockaddr)) != 00) {
			close(l_sock);
			ESP_LOGE(TAG, " 65 Client_Connect - Network Connection error.");
			vTaskDelay(1000 / portTICK_RATE_MS);
			continue;
		}
		return l_sock;
	}
}

// ### END DBK
